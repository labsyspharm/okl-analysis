---
title: "Analysis of "
output: html_document
editor_options:
  chunk_output_type: console
---

```{r setup}
library(tidyverse)
library(synExtra)
library(here)
library(fst)
library(data.table)
library(powerjoin)
# library(dtplyr)

theme_set(theme_minimal())

synapser::synLogin()
syn <- synDownloader("~/data/", .cache = TRUE)
```

```{r loading}
inputs <- list(
  okl_single_dose_datasets = "syn52504516",
  kinase_info = "syn51286743",
  okl_pseudo_kds = "syn51080578",
  partition_index_max = "syn52576129"
)

input_files <- map(
  inputs, syn
)

single_dose <- input_files[["okl_single_dose_datasets"]] %>%
  read_csv() %>%
  filter(dataset == "original_repeat_replaced")

kinase_info <- input_files[["kinase_info"]] %>%
  read_csv() %>%
  filter(`DiscoveRx Gene Symbol` %in% single_dose$`DiscoveRx Gene Symbol`)

mutant_panel <- kinase_info %>%
  mutate(
    mutant = str_detect(`Kinase Form`, "Mutation")
  ) %>%
  filter(mutant) %>%
  bind_rows(
    filter(
      kinase_info,
      `Kinase Form` == "Wild Type",
      hgnc_symbol %in% .$hgnc_symbol
    ) %>%
      mutate(mutant = FALSE)
  )

pseudo_kds <- input_files[["okl_pseudo_kds"]] %>%
  fread() %>%
  as_tibble() %>%
  filter(dataset == "original_repeat_replaced")

partition_index_max <- input_files[["partition_index_max"]] %>%
  read_csv() %>%
  filter(dataset == "original_repeat_replaced")
```


```{r}
pseudo_kds_dedup <- pseudo_kds %>%
  filter(
    hgnc_symbol != "",
    classification != "discordant",
    pseudo_kd_concordant != "discordant",
    !exclude_target,
    library == "OKL"
  ) %>%
  group_by(lspci_id, hgnc_symbol, `DiscoveRx Gene Symbol`) %>%
  slice_min(
    pseudo_kd,
    with_ties = FALSE,
    na_rm = TRUE
  ) %>%
  ungroup()

CUTOFFS <- c(100, 1000)
TOP_N <- 15

most_inhibited_raw <- pseudo_kds_dedup %>%
  group_by(hgnc_symbol, `DiscoveRx Gene Symbol`) %>%
  summarize(
    n_inhibitors = map_int(
      set_names(CUTOFFS),
      ~ sum(pseudo_kd <= as.numeric(.x), na.rm = TRUE)
    ) %>%
      list(),
    .groups = "drop"
  )

most_inhibited <- most_inhibited_raw %>%
  unnest_longer(n_inhibitors, indices_to = "cutoff", values_to = "n_inhibitors") %>%
  mutate(across(cutoff, as.numeric)) %>%
  arrange(desc(n_inhibitors))

most_inhibited %>%
  count(cutoff, n_inhibitors) %>%
  View()

most_targets_raw <- pseudo_kds_dedup %>%
  group_by(lspci_id, hmsl_id, library, name) %>%
  summarize(
    n_targets = map_int(
      set_names(CUTOFFS),
      ~ sum(pseudo_kd <= as.numeric(.x), na.rm = TRUE)
    ) %>%
      list(),
    .groups = "drop"
  )

most_targets <- most_targets_raw %>%
  unnest_longer(n_targets, indices_to = "cutoff", values_to = "n_targets") %>%
  mutate(across(cutoff, as.numeric)) %>%
  arrange(desc(n_targets))
```


```{r}
library(UpSetR)

most_inhibited_inhibitors <- most_inhibited %>%
  group_by(cutoff) %>%
  slice_head(n = TOP_N) %>%
  ungroup() %>%
  inner_join(
    pseudo_kds_dedup,
    by = c("DiscoveRx Gene Symbol", "hgnc_symbol"),
    relationship = "many-to-many"
  ) %>%
  mutate(
    inhibited = pseudo_kd <= cutoff
  ) %>%
  group_by(lspci_id, cutoff) %>%
  filter(sum(inhibited) > 0) %>%
  ungroup()

most_inhibited_inhibitors_mats <- most_inhibited_inhibitors %>%
  select(name, lspci_id, `DiscoveRx Gene Symbol`, cutoff, inhibited) %>%
  group_nest(cutoff) %>%
  mutate(
    data = map(
      data,
      \(x) pivot_wider(x, names_from = `DiscoveRx Gene Symbol`, values_from = inhibited, values_fill = FALSE)
    )
  )

```

```{r}
most_inhibited_inhibitors_table <- most_inhibited_inhibitors %>%
  filter(inhibited) %>%
  arrange(cutoff, lspci_id, `DiscoveRx Gene Symbol`) %>%
  group_by(cutoff, lspci_id, name) %>%
  summarize(
    inhibited = list(`DiscoveRx Gene Symbol`),
    .groups = "drop"
  ) %>%
  group_by(cutoff, inhibited) %>%
  summarize(
    names = list(name),
    .groups = "drop"
  ) %>%
  mutate(
    inhibited_str = map_chr(inhibited, \(x) paste(x, collapse = ", ")),
    names_str = map_chr(names, \(x) paste(x, collapse = ", ")),
    n_inhibited = map_int(inhibited, length),
    n_compounds = map_int(names, length)
  ) %>%
  arrange(cutoff, desc(n_inhibited))

write_csv(
  most_inhibited_inhibitors_table %>%
    select(where(negate(is.list))),
  here("data", paste0("top", TOP_N, "_most_inhibited_kinases_inhibitor_overlap_table.csv"))
)
```


```{r}
ps <- most_inhibited_inhibitors_mats %>%
  mutate(
    p = map(
      data,
      \(x) {
        # browser()
        colnames(x) <- str_replace(colnames(x), fixed("JH1domain-"), "")
        ComplexUpset::upset(
          select(x, -name, -lspci_id) %>%
            as.data.frame(),
          colnames(x) %>%
            setdiff(c("name", "lspci_id")),
          min_size = 2,
          name = "Compound targets",
          height_ratio = 1.5,
          width_ratio = .25
        )
      }
    )
  )

pwalk(
  ps,
  function(p, cutoff, ...) {
    ggsave(
      here("plots", paste0("upset_top", TOP_N, "_kinase_targets_cutoff_", cutoff, ".pdf")),
      p, width = 5.5, height = 4
    )
  }
)

```

```{r}
library(seriation)
library(ComplexHeatmap)

clust_fun <- function(m) {
  d <- dist(m, method = "euclidian")
  hclust(d, method = "average") %>%
    reorder(d, method = "olo")
}

most_inhibited_inhibitors_hms <- most_inhibited_inhibitors_mats %>%
  mutate(
    hm = map2(
      data, cutoff,
      \(x, co) {
        m <- select(
          x, -name, -lspci_id
        ) %>%
         as.matrix()
        # m_ <- m[rowSums(m) > 0, ] * 1
        m_ <- m[rowSums(m) > 0, ] %>%
          magrittr::set_colnames(str_replace(colnames(.), fixed("JH1domain-"), ""))
        # browser()
        Heatmap(
          ifelse(m_, "hit", "miss"),
          col = c(hit = "#ec4e4ec1", miss = "#cbd4ff"),
          cluster_columns = clust_fun(t(m_)),
          cluster_rows = clust_fun(m_),
          name = " "
        )
        # pheatmap::pheatmap(
        #   m_,
        #   cluster_cols = clust_fun(t(m_)),
        #   cluster_rows = clust_fun(m_),
        #   main = co
        # )
      }
    )
  )

pwalk(
  most_inhibited_inhibitors_hms,
  function(hm, cutoff, ...) {
    withr::with_pdf(
      here("plots", paste0("upset_top", TOP_N, "_kinase_targets_cutoff_", cutoff, "_heatmap.pdf")),
      print(hm), width = 4, height = 4
    )
  }
)


```



```{r}

library(SuperExactTest)
set_input <- most_inhibited_inhibitors %>%
  filter(inhibited) %>%
  group_by(cutoff, hgnc_symbol) %>%
  summarize(
    inhibs = list(name),
    .groups = "drop"
  ) %>%
  group_by(cutoff) %>%
  summarize(
    data = set_names(inhibs, hgnc_symbol) %>%
      list(),
    .groups = "drop"
  )

set_res <- set_input %>%
  mutate(
    res = map(
      data,
      \(x) SuperExactTest::supertest(x, n = length(unique(pseudo_kds$hgnc_symbol)))
    )
  )

pwalk(
  set_res,
  function(res, cutoff, ...) {
    withr::with_cairo_pdf(
      here("plots", paste0("top", TOP_N, "_inhibited_kinases_inhibitor_overlap_cutoff_", cutoff, ".pdf")),
      plot(
        res,
        Layout = "landscape",
        min.intersection.size = 3,
        degree = c(10, 9, 8),
        sort.by = "size",
        show.expected.overlap = TRUE
        # sort.by = x$overlap.sizes %>%
        #   sort() %>%
        #   magrittr::is_greater_than(5) %>%
        #   names(),
        #   Layout = "landscape",
        #   ke
      ), width = 8, height = 4
    )
  }
)

set_plots <- set_res %>%
  mutate(
    plot = map(
      res,
      \(x) {
        plot(
          x,
          Layout = "landscape",
          min.intersection.size = 3,
          sort.by = "size",
          show.expected.overlap = TRUE
          # sort.by = x$overlap.sizes %>%
          #   sort() %>%
          #   magrittr::is_greater_than(5) %>%
          #   names(),
          #   Layout = "landscape",
          #   ke
        )
      }
    )
  )

```


```{r}
partition_index_max_unique <- partition_index_max %>%
  distinct(name, lspci_id, partition_index)

inhibitors_n_kinases <- most_inhibited_inhibitors %>%
  filter(inhibited) %>%
  group_by(cutoff, lspci_id, name) %>%
  summarize(
    n_kinases = n(),
    .groups = "drop"
  ) %>%
  arrange(cutoff, desc(n_kinases))



ps <- inhibitors_n_kinases %>%
  group_nest(cutoff) %>%
  mutate(
    p = map(
      data,
      \(x) {
        # browser()
        df <- partition_index_max_unique %>%
          semi_join(
            pseudo_kds_dedup,
            by = "lspci_id"
          ) %>%
          left_join(
            x,
            by = c("lspci_id", "name")
          ) %>%
          mutate(
            n_kinases = n_kinases %>%
              replace_na(0) %>%
              as.character() %>%
              fct_inseq(ordered = TRUE),
            name = factor(name, levels = name[order(partition_index)])
          )
        ggplot(
          df,
          aes(
            x = name,
            y = partition_index,
            fill = n_kinases
          )
        ) +
          geom_step(group = 1) +
          geom_col(
            aes(
              y = 0.05
            ),
            data = \(y) filter(y, as.numeric(as.character(n_kinases)) > 0)
          ) +
          scale_fill_viridis_d(
            drop = FALSE
          ) +
          scale_color_viridis_d(
            aesthetics = "segment.color",
            drop = FALSE
          ) +
          ggrepel::geom_text_repel(
            aes(
              label = name,
              segment.color = n_kinases,
              # fill = n_kinases,
              y = .05
            ),
            data = \(y) filter(y, as.numeric(as.character(n_kinases)) > 7),
            color = "black",
            direction = "x",
            size = 2.5,
            vjust = 1,
            hjust = 1,
            nudge_y = .6,
            angle = 90,
            seed = 42,
            max.overlaps = 100,
            show.legend = FALSE
          ) +
          theme(
            axis.title.x = element_blank(),
            axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            panel.grid.major.x = element_blank(),
          )
      }
    )
  )

pwalk(
  ps,
  function(p, cutoff, ...) {
    ggsave(
      here("plots", paste0("top", TOP_N, "_inhibited_kinases_inhibitor_overlap_size_cutoff_", cutoff, ".pdf")),
      p, width = 8, height = 4
    )
  }
)

```


```{r}

pseudo_kds_inhibited <- pseudo_kds_dedup %>%
  crossing(threshold = CUTOFFS) %>%
  filter(pseudo_kd <= threshold)

write_csv(
  pseudo_kds_inhibited %>%
    filter(threshold == 1000),
  here("data", "pseudo_kds_inhibited_1000_threshold.csv")
)


pseudo_kds_n_inhibited <- pseudo_kds_inhibited %>%
  group_by(lspci_id, threshold) %>%
  summarize(
    n_inhibited = n(),
    .groups = "drop"
  )

pseudo_kds_inhibited %>%
  filter(threshold == 1000) %>%
  group_by(hgnc_symbol) %>%
  summarize(
    n = n(),
    .groups = "drop"
  ) %>%
  pull(n) %>%
  paste(collapse = ", ") %>%
  clipr::write_clip()

pseudo_kds_n_inhibited %>%
  filter(threshold == 1000) %>%
  pull(n_inhibited) %>%
  paste(collapse = ", ") %>%
  clipr::write_clip()
```


```{r}
hgnc_id_map <- pseudo_kds_inhibited %>%
  filter(threshold == 1000) %>%
  group_by(hgnc_symbol) %>%
  summarize(
    n = n(),
    .groups = "drop"
  ) %>%
  select(hgnc_symbol) %>%
  mutate(
    id = seq_len(n()) - 1
  )

lspci_id_map <- pseudo_kds_n_inhibited %>%
  filter(threshold == 1000) %>%
  select(lspci_id) %>%
  mutate(
    id = seq_len(n()) - 1
  )

random_matrices_1000_threshold <- syn("syn54155262") %>%
  read_csv() %>%
  magrittr::set_colnames(c("matrix_id", "row_id", "col_id")) %>%
  power_inner_join(
    hgnc_id_map,
    by = c("row_id" = "id"),
    check = check_specs(
      unmatched_keys_left = "warn",
      unmatched_keys_right = "warn",
      duplicate_keys_right = "warn"
    )
  ) %>%
  power_inner_join(
    lspci_id_map,
    by = c("col_id" = "id"),
    check = check_specs(
      unmatched_keys_left = "warn",
      unmatched_keys_right = "warn",
      duplicate_keys_right = "warn"
    )
  )

random_and_real_1000_threshold <- bind_rows(
  pseudo_kds_inhibited %>%
    filter(threshold == 1000) %>%
    transmute(matrix_id = -1, lspci_id, hgnc_symbol),
  random_matrices_1000_threshold
)

pseudo_kds_inhibited_n_inhibs_per_kinase <- pseudo_kds_inhibited %>%
  count(threshold, hgnc_symbol) %>%
  arrange(threshold, desc(n))

top_15_1000 <- pseudo_kds_inhibited_n_inhibs_per_kinase %>%
  filter(threshold == 1000) %>%
  slice_head(n = 15)

random_and_real_1000_n_overlap_top_15_kinases <- random_and_real_1000_threshold %>%
  filter(hgnc_symbol %in% top_15_1000$hgnc_symbol) %>%
  count(matrix_id, lspci_id, name = "n_kinases")


random_and_real_1000_n_overlap_top_15_kinases_n_inhibs_per_group <- random_and_real_1000_n_overlap_top_15_kinases %>%
  count(matrix_id, n_kinases, name = "n_inhibitors") %>%
  complete(matrix_id, n_kinases, fill = list(n_inhibitors = 0))

p <- random_and_real_1000_n_overlap_top_15_kinases_n_inhibs_per_group %>%
  filter(matrix_id >= 0) %>%
  ggplot(
    aes(fct_inseq(as.character(n_kinases)), n_inhibitors)
  ) +
  ggbeeswarm::geom_quasirandom(
    dodge.width = .5,
    alpha = 0.5, orientation = "x"
  ) +
  geom_point(
    data = filter(random_and_real_1000_n_overlap_top_15_kinases_n_inhibs_per_group, matrix_id == -1),
    size = 4,
    color = "red"
  ) +
  geom_text(
    aes(label = signif(p, 2)),
    y = Inf,
    vjust = 1,
    data = random_and_real_1000_n_overlap_top_15_kinases_n_inhibs_per_group_p
  ) +
  labs(
    x = "Number of top 15 kinases hit",
    y = "Number of inhibitors"
  )

ggsave(
  here("plots", "top_15_kinases_n_inhibitors.pdf"),
  p, width = 8, height = 4
)

random_and_real_1000_n_overlap_top_15_kinases_n_inhibs_per_group_p <- random_and_real_1000_n_overlap_top_15_kinases_n_inhibs_per_group %>%
  filter(matrix_id >= 0) %>%
  inner_join(
    random_and_real_1000_n_overlap_top_15_kinases_n_inhibs_per_group %>%
      filter(matrix_id == -1) %>%
      select(n_kinases, n_inhibitors_real = n_inhibitors),
    by = "n_kinases"
  ) %>%
  group_by(n_kinases) %>%
  summarize(p = sum(n_inhibitors >= n_inhibitors_real) / n(), .groups = "drop")

```

Heatmap of mutant panel

```{r}
library(ComplexHeatmap)
library(seriation)

cluster_fun_eucl <- function(mat) {
  # browser()
  dist_mat <- dist(mat)
  # dist_mat <- as.dist(mat)
  clust <- hclust(dist_mat, method = "average")
  reorder(clust, dist_mat, method = "OLO")
}

createAnnotation <- function(df, colors = list(), which = "column") {
  # Load necessary libraries
  library(ComplexHeatmap)
  library(circlize)
  library(rlang)

  color_maps <- list()

  # Iterate over each column in the dataframe
  for (col_name in names(df)) {
    # Check if the column is numeric
    if (is.numeric(df[[col_name]])) {
      # Create a color mapping function for numeric columns
      col_fun <- colors[[col_name]] %||% colorRamp2(seq(from = min(df[[col_name]]), to = max(df[[col_name]]), length.out = 2),
                            c("white", "red"))
      color_maps[[col_name]] <- col_fun
    } else {
      if (is.character(colors[[col_name]])) {
        color_maps[[col_name]] <- colors[[col_name]]
        next
      }
      col_fun <- colors[[col_name]] %||% rainbow
      # Create a named vector of colors for categorical columns
      values <- df[[col_name]]
      unique_values <- if (is.factor(values)) levels(values) else unique(df[[col_name]])
      named_colors <- setNames(col_fun(length(unique_values)), unique_values)
      color_maps[[col_name]] <- named_colors
    }
  }

  # Combine all annotations
  combined_annotations <- HeatmapAnnotation(df = df, col = color_maps, which = which)

  return(combined_annotations)
}
```

Redo computation with all kinases included, even mutant ones

```{r}
pseudo_kds_dedup_no <- pseudo_kds %>%
  filter(
    hgnc_symbol != "",
    classification != "discordant",
    pseudo_kd_concordant != "discordant",
    library == "OKL"
  ) %>%
  group_by(lspci_id, hgnc_symbol, `DiscoveRx Gene Symbol`) %>%
  slice_min(
    pseudo_kd,
    with_ties = FALSE,
    na_rm = TRUE
  ) %>%
  ungroup()

CUTOFFS <- c(100, 1000)
TOP_N <- 15

most_inhibited_raw_no <- pseudo_kds_dedup_no %>%
  group_by(hgnc_symbol, `DiscoveRx Gene Symbol`) %>%
  summarize(
    n_inhibitors = map_int(
      set_names(CUTOFFS),
      ~ sum(pseudo_kd <= as.numeric(.x), na.rm = TRUE)
    ) %>%
      list(),
    .groups = "drop"
  )

most_inhibited_no <- most_inhibited_raw_no %>%
  unnest_longer(n_inhibitors, indices_to = "cutoff", values_to = "n_inhibitors") %>%
  mutate(across(cutoff, as.numeric)) %>%
  arrange(desc(n_inhibitors))

most_targets_raw_no <- pseudo_kds_dedup_no %>%
  group_by(lspci_id, hmsl_id, library, name) %>%
  summarize(
    n_targets = map_int(
      set_names(CUTOFFS),
      ~ sum(pseudo_kd <= as.numeric(.x), na.rm = TRUE)
    ) %>%
      list(),
    .groups = "drop"
  )

most_targets_no <- most_targets_raw_no %>%
  unnest_longer(n_targets, indices_to = "cutoff", values_to = "n_targets") %>%
  mutate(across(cutoff, as.numeric)) %>%
  arrange(desc(n_targets))
```


```{r}
better_contrast <- function(
  colors1, colors2, threshold = 0
) {
  # browser()
  farver::compare_colour(
    farver::decode_colour(colors1),
    farver::decode_colour(colors2),
    from_space = "rgb",
    method = "cie2000"
  ) %>% {
      .[, 1] < (1 + threshold) * .[, 2]
    } %>%
    if_else(colors2[2], colors2[1])
}

mutant_hm_data <- tibble(
  cutoff = CUTOFFS
) %>%
  mutate(
    hm = map(
      cutoff,
      \(cu) {
        mat <- pseudo_kds_dedup_no %>%
          filter(`DiscoveRx Gene Symbol` %in% mutant_panel$`DiscoveRx Gene Symbol`) %>%
          transmute(`DiscoveRx Gene Symbol`, lspci_id, pseudo_kd = log10(pseudo_kd)) %>%
          pivot_wider(names_from = lspci_id, values_from = pseudo_kd) %>%
          column_to_rownames("DiscoveRx Gene Symbol") %>%
          as.matrix()
        mutant_panel_sub <- mutant_panel %>%
          slice(match(rownames(mat), `DiscoveRx Gene Symbol`))
        row_anno <- mutant_panel %>%
          left_join(
            most_inhibited_no %>%
              filter(cutoff == cu) %>%
              select(`DiscoveRx Gene Symbol`, n_inhibitors),
            by = "DiscoveRx Gene Symbol"
          ) %>%
          select(`DiscoveRx Gene Symbol`, Group, mutant, n_inhibitors) %>%
          slice(match(rownames(mat), `DiscoveRx Gene Symbol`)) %>%
          column_to_rownames("DiscoveRx Gene Symbol")
        col_anno <- most_targets_no %>%
          filter(cutoff == cu) %>%
          select(lspci_id, n_targets) %>%
          slice(match(colnames(mat), lspci_id)) %>%
          column_to_rownames("lspci_id")
        # browser()
        Heatmap(
          mat,
          name = "Pseudo Kd",
          col = viridisLite::viridis(100, direction = -1),
          cluster_columns = cluster_fun_eucl,
          cluster_rows = cluster_fun_eucl,
          row_split = mutant_panel_sub$hgnc_symbol,
          left_annotation = createAnnotation(
            row_anno,
            which = "row",
            colors = list(Group = \(x) RColorBrewer::brewer.pal(x, "Set2"))
          ),
          top_annotation = createAnnotation(
            col_anno,
            which = "column"
          ),
          show_column_names = FALSE,
          # cell_fun = \(j, i, x, y, width, height, fill) {
          #   # browser()
          #   if (!is.na(mat[i, j]) && mat[i, j] < log10(cu))
          #     grid.text("*", x, y, gp = gpar(fontsize = 10, col = better_contrast(fill, c("white", "black"))))
          # }
        )
      }
    )
  )



```
