---
title: "OKL single dose data wrangling"
author: "Clemens Hug"
date: "12/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(synExtra)
library(here)
library(fst)
library(data.table)

theme_set(theme_minimal())

synapser::synLogin()
syn <- synDownloader("~/data", .cache = TRUE)
```

## Load input

```{r load}
inputs <- list(
  compound_mapping = "syn26260389",
  exclusions = "syn26401280",
  okl1_1 = "syn26388880",
  okl1_2 = "syn25998856",
  okl2 = "syn26053108",
  okl2_repeat1 = "syn52223890",
  okl2_repeat2 = "syn52223891",
  kinase_info = "syn51286743"
)

input_files <- map(
  inputs, syn
)

compound_mapping <- input_files[["compound_mapping"]] %>%
  read_fst(as.data.table = TRUE)

exclusions <- input_files[["exclusions"]] %>%
  read_csv()

qpcr_misses <- syn("syn33531640") %>%
  readxl::read_excel() %>%
  left_join(
    compound_mapping[, .(lspci_id, external_id)] %>%
      unique(),
    by = c("Compound Name" = "external_id")
  )

single_dose_raw <- input_files %>%
  {.[str_starts(names(.), "okl")]} %>%
  map(syn) %>%
  map(fread) %>%
  rbindlist(idcol = "experiment")

kinase_info <- input_files[["kinase_info"]] %>%
  read_csv()
```

## Wrangle

We ran KinomeScan assays against the entire Kinome for all compounds in the
Optimal Kinase Library. There are three batches of experiments. Any earlier
KinomeScan runs are not included.

Furthermore, all targets assayed by KinomeScan that contain mutations are
flagged for exclusion.

Torin 1 was measured twice. Averaging measurements

```{r wrangle}
single_dose_lspci_id <- single_dose_raw %>%
  # Fix deprecated HMSLID
  mutate(`Compound Name` = recode(`Compound Name`, HMSL12274 = "HMSL11996")) %>% {
    compound_mapping[, .(lspci_id, hmsl_id = external_id)][
      .,
      on = c("hmsl_id" = "Compound Name")
    ]
  }

single_dose_lspci_id_repeat <- single_dose_lspci_id %>%
  filter(str_detect(experiment, "repeat"))

single_dose_lspci_id_repeat %>%
  dplyr::count(lspci_id, `DiscoveRx Gene Symbol`, `Compound Concentration (nM)`) %>%
  dplyr::count(n)

single_dose <- single_dose_lspci_id %>%
  left_join(
    qpcr_misses %>%
      transmute(
        lspci_id, `Ambit Gene Symbol`, `Compound Conc`,
        qpcr_miss = TRUE
      ),
    by = c("lspci_id", "DiscoveRx Gene Symbol" = "Ambit Gene Symbol", "Compound Concentration (nM)" = "Compound Conc")
  ) %>%
  replace_na(list(qpcr_miss = FALSE)) %>%
  mutate(
    exclude_target = `DiscoveRx Gene Symbol` %in% exclusions$`DiscoveRx Gene Symbol`
  ) %>%
  left_join(
    single_dose_lspci_id_repeat %>%
      distinct(lspci_id, `DiscoveRx Gene Symbol`, `Compound Concentration (nM)`) %>%
      mutate(superseded = TRUE)
  ) %>%
  mutate(
    superseded = if_else(str_detect(experiment, "repeat"), FALSE, replace_na(superseded, FALSE))
  ) %>%
  group_by(
    lspci_id, hmsl_id, `DiscoveRx Gene Symbol`, `Entrez Gene Symbol`,
    `Compound Concentration (nM)`, qpcr_miss, exclude_target, superseded
  ) %>%
  summarize(
    experiment = paste(experiment, collapse = "+"),
    across(`Percent Control`, mean),
    .groups = "drop"
  ) %>%
  mutate(
    tas = case_when(
      `Compound Concentration (nM)` == 10000 & `Percent Control` >= 50 ~ 10L,
      `Compound Concentration (nM)` == 10000 & `Percent Control` < 0.1 ~ 2L,
      `Compound Concentration (nM)` == 1000 & `Percent Control` >= 90 ~ 10L,
      `Compound Concentration (nM)` == 1000 & `Percent Control` < 1 ~ 2L,
      `Compound Concentration (nM)` == 100 & `Percent Control` >= 75 ~ 10L,
      `Compound Concentration (nM)` == 100 & `Percent Control` < 25 ~ 2L,
      TRUE ~ NA_integer_
    )
  ) %>%
  inner_join(
    kinase_info %>%
      select(`DiscoveRx Gene Symbol`, entrezgene_id, ensembl_gene_id, hgnc_symbol),
    by = "DiscoveRx Gene Symbol"
  ) %>%
  select(
    lspci_id, hmsl_id, `DiscoveRx Gene Symbol`, `Entrez Gene Symbol`, entrezgene_id, ensembl_gene_id, hgnc_symbol,
    everything()
  )

fwrite(single_dose, here("data", "okl_single_dose.csv.gz"))
```

## Upload to Synapse

```{r synapse}
activity <- synapser::Activity(
  name = "Wrangle OKL KinomeScan data",
  used = unname(inputs),
  executed = "https://github.com/labsyspharm/okl-analysis/blob/main/wrangle_data.Rmd"
)

c(
  here("data", "okl_single_dose.csv.gz")
) %>%
  synStoreMany(parentId = "syn18508401", activity = activity, forceVersion = FALSE)
```
