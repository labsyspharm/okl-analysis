
```{r}
library(tidyverse)
library(synExtra)
library(fst)
library(data.table)
library(powerjoin)

synapser::synLogin()

syn <- synDownloader("~/data", .cache = TRUE)
```

```{r}
kinomescan_kds <- syn("syn69680641") %>%
  read_csv()

kinomescan_classes <- syn("syn51080579") %>%
  read_csv()

kinomescan_kinase_info <- syn("syn51286743") %>%
  read_csv()


# qpcr_misses <- syn("syn33531640") %>%
#   readxl::read_excel() %>%
#   left_join(
#     compound_mapping[, .(lspci_id, external_id)] %>%
#       unique(),
#     by = c("Compound Name" = "external_id")
#   )

lsp_biochem <- syn("syn25173511") %>%
  read_fst()

nominal_targets <- syn("syn52947779") %>%
  read_csv() %>%
  power_inner_join(
    kinomescan_kds %>%
      distinct(lspci_id, hmsl_id),
    by = c("HMSLID" = "hmsl_id"),
    check = check_specs(
      duplicate_keys_right = "warn",
      unmatched_keys_left = "warn"
    )
  )

# lsp_clinical <- syn("syn26260451") %>%
#   read_fst() %>%
#   as_tibble()

okl_clinical <- syn("syn63303526") %>%
  read_csv()
```

Use updated `okl_clinical` instead. Hand-assembled by Caitlin

## Frequency nominal in top X targets

```{r}
nominal_targets_unique <- nominal_targets %>%
  filter(!is.na(`DiscoveRx Gene Symbol`), `DiscoveRx Gene Symbol` != "n/a") %>%
  transmute(lspci_id, `DiscoveRx Gene Symbol`, nominal_target = TRUE) %>%
  distinct()

kds_nominal_target_sorted <- kinomescan_kds %>%
  filter(
    dataset == "original_repeat_replaced",
    lspci_id %in% nominal_targets_unique$lspci_id
  ) %>%
  power_left_join(
    nominal_targets_unique,
    by = c("lspci_id", "DiscoveRx Gene Symbol"),
    check = check_specs(
      duplicate_keys_right = "warn"
    )
  ) %>%
  power_left_join(
    okl_clinical %>%
      group_by(hmsl_id = HMSLID) %>%
      summarize(
        approved = if_else(any(status == "approved"), "Approved", "Not approved"),
        .groups = "drop"
      ) %>%
      select(hmsl_id, approved),
    by = "hmsl_id",
    check = check_specs(
      duplicate_keys_right = "warn"
    )
  ) %>%
  replace_na(
    replace = list(
      nominal_target = FALSE,
      approved = "Not approved"
    )
  ) %>%
  arrange(
    lspci_id, kd
  ) %>%
  group_by(lspci_id) %>%
  mutate(
    rank = rank(kd, ties.method = "first")
  ) %>%
  ungroup()
```

Only keep nominal target with best (lowest) Kd,
this will take care of cases with multiple nominal targets

```{r}
kds_nominal_top_n <- kds_nominal_target_sorted %>%
  group_by(lspci_id) %>%
  slice(
    which(nominal_target)[1]
  ) %>%
  ungroup()

kds_nominal_top_n_plot_data <- kds_nominal_top_n %>%
  group_by(rank) %>%
  summarize(
    n_rank = n(),
    .groups = "drop"
  ) %>%
  arrange(rank) %>%
  mutate(
    n_cumsum = cumsum(n_rank),
    proportion_in_top_n = n_cumsum / length(unique(kds_nominal_target_sorted$lspci_id))
  )

p <- kds_nominal_top_n_plot_data %>%
  ggplot(aes(rank, proportion_in_top_n)) +
  geom_point() +
  geom_step() +
  scale_x_log10() +
  # geom_hline(yintercept = 1, linetype = "dashed") +
  labs(
    x = "Top N targets",
    y = "Proportion of compounds with\nintended target in top N targets"
  )
p
ggsave(
  "plots/nominal_target_in_top_n_fitted.pdf",
  p, width = 5, height = 3
)

FISHER_RANK_CUT <- 3L
kds_nominal_fisher_data <- kds_nominal_target_sorted %>%
  filter(rank <= FISHER_RANK_CUT) %>%
  group_by(lspci_id, name, approved) %>%
  summarize(
    nominal_target_hit = any(nominal_target),
    .groups = "drop"
  )

kds_nominal_fisher_table <- kds_nominal_fisher_data %>%
  transmute(
    Approval = approved,
    `Intended target in top 3` = if_else(nominal_target_hit, "Yes", "No")
  ) %>%
  table()

fisher.test(kds_nominal_fisher_table)

withr::with_pdf(
  "plots/nominal_target_in_top_3_fisher_mosaic_fitted.pdf", width = 3, height = 3,
  mosaicplot(
    kds_nominal_fisher_table,
    main = "",,
    color = paletteer::paletteer_d("ggsci::category10_d3")
  )
)

```

        Fisher's Exact Test for Count Data

data:  .
p-value = 0.02555
alternative hypothesis: true odds ratio is not equal to 1
95 percent confidence interval:
 1.062060 5.307341
sample estimates:
odds ratio
  2.345732


```{r}
kds_nominal_top_n_plot_data_clinical <- kds_nominal_top_n %>%
  group_by(rank, approved) %>%
  summarize(
    n_rank = n(),
    .groups = "drop"
  ) %>%
  arrange(rank) %>%
  group_by(approved) %>%
  mutate(
    n_cumsum = cumsum(n_rank),
    proportion_in_top_n = n_cumsum / sum(n_rank)
  ) %>%
  ungroup()

p <- kds_nominal_top_n_plot_data_clinical %>%
  ggplot(aes(rank, proportion_in_top_n, color = approved)) +
  geom_point(alpha = 0.7) +
  geom_step(alpha = 0.7) +
  scale_x_log10() +
  # geom_hline(yintercept = 1, linetype = "dashed") +
  labs(
    x = "Top N targets",
    y = "Proportion of compounds with\nintended target in top N targets"
  )
p
ggsave(
  "plots/nominal_target_in_top_n_clinical_fitted.pdf",
  p, width = 5, height = 3
)

```


## Novel hit per kinase

```{r}
kd_thresholds <- c(100, 1000, 10000)

biochem_kd <- lsp_biochem %>%
  filter(symbol %in% kinomescan_kds$hgnc_symbol) %>%
  power_left_join(
    kinomescan_kds %>%
      filter(dataset == "original_repeat_replaced") %>%
      group_by(lspci_id, hgnc_symbol) %>%
      summarize(
        kd = min(kd),
        .groups = "drop"
      ),
    by = c("lspci_id", "symbol" = "hgnc_symbol"),
    check = check_specs(
      duplicate_keys_right = "warn"
    )
  )

novel_hits <- tibble(
  kd_threshold = kd_thresholds
) %>%
  mutate(
    data = map(
      kd_threshold,
      ~biochem_kd %>%
        group_by(
          symbol
        ) %>%
        summarize(
          hit_by_chembl = any(value < .x, na.rm = TRUE),
          hit_by_kinomescan = any(kd < .x, na.rm = TRUE),
          .groups = "drop"
        )
    )
  )

p <- novel_hits %>%
  unnest(data) %>%
  filter(!hit_by_chembl, hit_by_kinomescan) %>%
  group_by(kd_threshold) %>%
  summarize(
    n = n(),
    symbols = paste(symbol, collapse = ", "),
    .groups = "drop"
  ) %>%
  mutate(
    across(kd_threshold, \(x) fct_inseq(as.character(x), ordered = TRUE) %>% fct_relabel(\(y) paste0("â‰¤", y)))
  ) %>%
  ggplot(aes(kd_threshold, n)) +
  geom_col() +
  geom_text(
    aes(label = symbols),
    vjust = -0.5
  ) +
  labs(
    x = "Kd threshold",
    y = "Number of novel hits"
  )

ggsave(
  "plots/novel_hits_per_kinase_fitted.pdf",
  p, width = 6, height = 4,
  device = Cairo::CairoPDF
)
```

